<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using DataPackageR • DataPackageR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">DataPackageR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using DataPackageR</h1>
                        <h4 class="author">Greg Finak <a href="mailto:gfinak@fredhutch.org">gfinak@fredhutch.org</a>
</h4>
            
            <h4 class="date">2017-05-19</h4>
          </div>

    
    
<div class="contents">
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#overview" class="anchor"> </a></body></html>Overview</h2>
<p>This package enables the command <code>R CMD DataPackageR &lt;packagename&gt;</code>. The <code>DataPackageR</code> command is meant to run user-defined code in an <code>R</code> package to process, transform, tidy, or otherwise standardize raw data into data sets or objects to be stored in the <code>pacakgename/data</code> directory.</p>
<p>Additionally, it supports data versioning via a <code>DataVersion: x.y.z</code> string in the package <code>DESCRIPTION</code> file, and automatically checks if data has changed between invocations. Furthermore, if <code>roxygen</code> documenation is available for the data sets as part of the user-defined data processing code, it will be extracted and copied to <code>packagename/R</code> where it can be parsed by the <code>roxygen</code> package.</p>
<div id="credit-where-its-due" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#credit-where-its-due" class="anchor"> </a></body></html>Credit where it’s due</h3>
<p>The concepts here are borrowed from a variety of ideas floating around the R user community, from people like Yihui Xie, Hadley Wickham, and Robert Gentleman. This package just puts some of that together into a single framework.</p>
</div>
</div>
<div id="why-not-use-the-existing-data-directory-mechanism" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#why-not-use-the-existing-data-directory-mechanism" class="anchor"> </a></body></html>Why not use the existing <code>data</code> directory mechanism?</h2>
<p>R packages run <code>.R</code> code in <code>/data</code> as part of the build process. However, this code is invoked each time a data set is attached using <code>data()</code>. In many instances, the processing that needs to be done to a raw data set may be complex and too time consuming to be part of the regular build process. Since the build time is a consideration for packages getting accepted into various repositories, there’s a need for a separate data processing step that precedes the usual <code>build</code>.</p>
<p>Additionally, data versioning and consistency checks are nice to have, as is the ability to keep code that generates data together with the data.</p>
</div>
<div id="how-to-build-a-data-package-that-uses-datapackager" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#how-to-build-a-data-package-that-uses-datapackager" class="anchor"> </a></body></html>How to build a data package that uses DataPackageR</h2>
<p>We assume we want to build a data package called <code>myDataPackage</code>. We load the <code>DataPackageR</code> library and use its convenience functions to get started.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test&lt;-<span class="st">""</span>
<span class="kw">library</span>(DataPackageR)
if(<span class="kw">dir.exists</span>(<span class="st">"/tmp/MyDataPackage"</span>)){
  <span class="kw">sapply</span>(<span class="kw">list.files</span>(<span class="dt">path=</span><span class="st">"/tmp/MyDataPackage"</span>,<span class="dt">full.names =</span> <span class="ot">TRUE</span>),unlink)
  <span class="kw">unlink</span>(<span class="st">"/tmp/MyDataPackage"</span>,<span class="dt">recursive=</span><span class="ot">TRUE</span>)
}</code></pre></div>
<p>The command above sets up the package skeleton in the <code>/tmp</code> directory for our new package.</p>
<p>Let’s generate some “raw data” that we want to process.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
mat&lt;-<span class="kw">spread</span>(<span class="kw">data.frame</span>(<span class="dt">sample=</span><span class="dv">1</span>:<span class="dv">100</span>,
          <span class="dt">measurement=</span><span class="kw">matrix</span>(<span class="kw">sapply</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>),
           function(x)<span class="kw">rnorm</span>(<span class="dv">100</span>,<span class="dt">mean=</span>x)),<span class="dt">ncol=</span><span class="dv">1</span>),
          <span class="dt">subject_id=</span><span class="kw">gl</span>(<span class="dv">4</span>,<span class="dv">100</span>,<span class="dt">labels=</span><span class="kw">c</span>(<span class="st">"Subject_1"</span>,
                        <span class="st">"Subject_2"</span>,<span class="st">"Subject_3"</span>,<span class="st">"Subject_4"</span>))),
          <span class="dt">key=</span>subject_id,<span class="dt">value=</span>measurement)
<span class="kw">head</span>(mat)</code></pre></div>
<pre><code>##   sample  Subject_1 Subject_2 Subject_3 Subject_4
## 1      1  0.4188106  2.629201  5.711289 10.739158
## 2      2  2.5143052  1.432127  6.238951  8.909735
## 3      3  1.3009815  2.276806  5.669918  9.585280
## 4      4 -0.6820117  3.237408  4.364036 10.578600
## 5      5  0.9078594  2.250976  4.630688  9.771288
## 6      6  0.5854412  1.635929  5.982592  8.999379</code></pre>
<p>We pretend that our raw data arrives as above: something is measured for four subjects, 100 times per subject, but each subject’s data is in a separate column. This is “wide” data, and generally doesn’t follow the tidy data paradigm of one variable per column. This data file will live in the <code>inst/extdata</code> directory beneath the package source tree.</p>
<p>We move our “raw data” into the <code>inst/extdata</code> directory in the package source tree.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(mat,<span class="dt">file=</span><span class="st">"/tmp/MyDataPackage/inst/extdata/raw_data.csv"</span>,<span class="dt">row.names=</span><span class="ot">FALSE</span>)</code></pre></div>
<p>Next we write our R code to do the data processing. The R code reads the raw data and reshapes it such that each column is a separate variable. Our processed data object is entitled <code>study_processed</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data&lt;-<span class="kw">read.csv</span>(<span class="st">"../inst/extdata/raw_data.csv"</span>,<span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)
study_processed&lt;-<span class="kw">gather</span>(data,<span class="dt">key=</span>subject_id,<span class="dt">value=</span>measurement,-sample)</code></pre></div>
<p>Let’s see what this looks like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(study_processed)</code></pre></div>
<pre><code>##   sample subject_id measurement
## 1      1  Subject_1   0.4188106
## 2      2  Subject_1   2.5143052
## 3      3  Subject_1   1.3009815
## 4      4  Subject_1  -0.6820117
## 5      5  Subject_1   0.9078594
## 6      6  Subject_1   0.5854412</code></pre>
<p>Our data are now in long format.</p>
<ul>
<li>This R code is placed in an <code>.R</code> file entitled <code>process_assay.R</code> within the <code>data-raw</code> directory.</li>
<li>The <code>datasets.R</code> file in <code>data-raw</code> is edited to contain:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sys.source</span>(<span class="st">"process_assay.R"</span>,<span class="dt">env=</span><span class="kw">topenv</span>()) <span class="co"># Ensures that process_assay.R is sourced properly</span>
objectsToKeep &lt;-<span class="st"> "study_processed"</span> <span class="co"># objectsToKeep is also used to generate roxygen boilerplate</span>
<span class="kw"><a href="../reference/keepDataObjects.html">keepDataObjects</a></span>(objectsToKeep)  <span class="co"># Specifies which data objects we want to keep in the package.</span></code></pre></div>
<p>The first line ensures the processing code is called when the package is built, and the second and third lines specify the data objects to be kept in the package and for which roxygen comments are to be generated. The <code><a href="../reference/datapackage.skeleton.html">datapackage.skeleton()</a></code> function creates a default datasets.R file that should serve as a good starting point.</p>
<p>Next we need some documentation for our data object(s). The default datasets.R file calls a function, <code>.autoDoc()</code> when it is built the first time. This function generates boilerplate roxygen comments and tags for the package and each object named in <code>objectsToKeep</code> and writes them to a file called <code>edit_and_rename_to_'documentation.R'.R</code>. The user should edit the file as desired and rename it to <code>documentation.R</code>. Any subsequent builds of the package will source the edited file for roxygen comments and tags. The initial file will look like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#' A data package for MyDataPackage.</span>
<span class="co">#' @docType package</span>
<span class="co">#' @aliases MyDataPackage-package</span>
<span class="co">#' @title Package Title</span>
<span class="co">#' @name MyDataPackage</span>
<span class="co">#' @description A description of the data package</span>
<span class="co">#' @details Use \\code{data(package='", pname, "')$results[, 3]} to see a list of available data sets in this data package</span>
<span class="co">#'     or DataPackageR::load_all_datasets() to load them.</span>
<span class="co">#' @seealso</span>
<span class="co">#' study_processed</span>
<span class="ot">NULL</span>

<span class="co">#' Detailed description of the data</span>
<span class="co">#' @name study_processed</span>
<span class="co">#' @docType data</span>
<span class="co">#' @title Descriptive data title</span>
<span class="co">#' @format a \code{data.frame} containing the following fields:</span>
<span class="co">#' \describe{</span>
<span class="co">#' \item{sample}{}</span>
<span class="co">#' \item{subject_id}{}</span>
<span class="co">#' \item{measurement}{}</span>
<span class="co">#' }</span>
<span class="co">#' @source The data comes from ________________________.</span>
<span class="co">#' @seealso</span>
<span class="co">#' MyDataPackage</span>
<span class="ot">NULL</span></code></pre></div>
<p>The <code>@name</code> tag must match the object name you are documenting. A <code>@title</code> is also required. It is good practice to document the data format, the provenance of the data, what the data represent, and so forth, and describe any transformations applied to the data (i.e. positivity calls). Also note the <code>@docType</code> tag, is <code>data</code> for data set chunk and <code>package</code> for the package chunk.</p>
<p>Next we edit our package DESCRIPTION file. This file is autogenerated by <code><a href="../reference/datapackage.skeleton.html">datapackage.skeleton()</a></code>, and contains metatdata about our package. It should be edited to describe the package appropriately:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Package:<span class="st"> </span>MyDataPackage
Type:<span class="st"> </span>Package
Title:<span class="st"> </span>Fake Study Data Package
Version:<span class="st"> </span><span class="fl">1.0.0</span>
Date:<span class="st"> </span><span class="dv">2015-01-14</span>
Author:<span class="st"> </span>Greg Finak
Maintainer:<span class="st"> </span>Greg Finak &lt;gfinak@fredhutch.org&gt;
Description:<span class="st"> </span>This is a data package for a fake study with 
standardized assay data for our fake assay.
License:<span class="st"> "file LICENSE"</span>
DataVersion:<span class="st"> </span><span class="fl">1.0.0</span></code></pre></div>
<p>Note <code>Package:</code> is the package name, <code>DataVersion:</code> is a version string for the data set, <code>Version:</code> is a version string for the package. The version might be bumped if the processing code or documentation changes. The <code>DataVersion</code> would be bumped whenever the underlying data objects created by the processing code change. The build process will warn you when this happens.</p>
<p>The <code>License:</code> string specifies a non-standard license present in a file entitled <code>LICENSE</code>. Ensure this file is present. For the time-being we put something like the following in the LICENSE file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">This data package is governed by the CAVD DATA &amp;<span class="st"> </span>MATERIALS SHARING AGREEMENT.
https:<span class="er">//</span>www.cavd.org/about/Pages/LegalAgreements.aspx</code></pre></div>
</div>
<div id="run-the-process-document-build-pipeline-" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#run-the-process-document-build-pipeline-" class="anchor"> </a></body></html>Run the process, document, build pipeline.</h2>
<p>The data package is essentially done. Next we want to run the processing code, build the documentation, and then build the package. There are two ways to do this.</p>
<ol style="list-style-type: decimal">
<li>From the command line</li>
</ol>
<ul>
<li>Run <code>R CMD DataPackageR MyDataPackage</code> from the <code>/tmp</code> directory. This will run the processing code and generate data sets and the roxygen documentation template.</li>
<li>Edit <code>R/MyDataPackage.R</code>.</li>
<li>Next run <code>roxygenize("MyDataPackage")</code> from within R to generate the <code>Rd</code> documentation files.<br>
</li>
<li>Finally build your package using <code>R CMD build MyDataPackage</code>.</li>
</ul>
<p>It’s simpler to do all this at once from within R using the <code>buildDataSetPackage</code> command.</p>
<ol start="2" style="list-style-type: decimal">
<li>Within R, run <code><a href="../reference/buildDataSetPackage.html">buildDataSetPackage("MyDataPackage")</a></code>, which will run the data preprocessing, build the default documentation, and build the package.</li>
<li>Edit and rename the file <code>data-raw/edit_and_rename_to_'documentation.R'.R</code>, then run <code><a href="../reference/buildDataSetPackage.html">buildDataSetPackage("MyDataPackage")</a></code> again.</li>
</ol>
<ul>
<li>If you get errors, fix them. Most importantly, if your data has changed, but the <code>DataVersion</code> string has not been incremented in the <code>DESCRIPTION</code> file, the pacakge will not build.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(DataPackageR)
<span class="kw"><a href="../reference/buildDataSetPackage.html">buildDataSetPackage</a></span>(<span class="st">"/tmp/MyDataPackage"</span>)
<span class="kw">install.packages</span>(<span class="st">"/tmp/MyDataPackage_1.0.0.tar.gz"</span>,<span class="dt">repos =</span> <span class="ot">NULL</span>)</code></pre></div>
</div>
<div id="next-steps" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#next-steps" class="anchor"> </a></body></html>Next steps</h2>
<p>Check the built package.</p>
<ul>
<li>Run <code>R CMD check MyDataPackage_1.0.0.tar.gz</code> to check that the package is error-free and can be installed.</li>
</ul>
<p>Install the package</p>
<ul>
<li>In the usual way, <code>R CMD INSTALL MyDataPackage_1.0.0.tar.gz</code>.</li>
</ul>
<p>The data are now availalbe within R by running</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MyDataPackage) <span class="co">#Load the data package</span>
<span class="kw">data</span>(<span class="dt">package=</span><span class="st">'MyDataPackage'</span>)$results[, <span class="dv">3</span>] <span class="co"># View all available data sets</span>
<span class="kw"><a href="../reference/load_all_datasets.html">load_all_datasets</a></span>(MyDataPackage) <span class="co"># Attach the data sets</span>
?MyDataPackage <span class="co">#Get help</span></code></pre></div>
<p>You can have analysis reports depend on your versioned data by using <code><a href="../reference/dataVersion.html">dataVersion("mypackage")</a></code> to retreive the DataVersion string.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/dataVersion.html">dataVersion</a></span>(<span class="st">"MyDataPackage"</span>)</code></pre></div>
<pre>
## [1] '1.0.0'
</pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#why-not-use-the-existing-data-directory-mechanism">Why not use the existing <code>data</code> directory mechanism?</a></li>
      <li><a href="#how-to-build-a-data-package-that-uses-datapackager">How to build a data package that uses DataPackageR</a></li>
      <li><a href="#run-the-process-document-build-pipeline.">Run the process, document, build pipeline.</a></li>
      <li><a href="#next-steps">Next steps</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
